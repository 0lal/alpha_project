syntax = "proto3";

package alpha.transport.rpc;

option java_multiple_files = true;
option java_package = "com.alpha.transport.rpc";
option go_package = "alpha/transport/rpc;rpc";

// Goal: إدارة المصادقة والجلسات وتبادل مفاتيح الخدمة.
// Dependencies: All Services, Security Policy Engine

// المصادقة وتبادل المفاتيح (Sessions, Handshakes)
service AuthGateway {
  rpc OpenSession(OpenSessionRequest) returns (OpenSessionResponse);
  rpc RefreshSession(RefreshSessionRequest) returns (RefreshSessionResponse);
  rpc Handshake(HandshakeRequest) returns (HandshakeResponse);
  rpc RevokeSession(RevokeSessionRequest) returns (RevokeSessionResponse);
}

enum AuthMethod {
  AUTH_METHOD_UNSPECIFIED = 0;
  AUTH_METHOD_API_KEY = 1;
  AUTH_METHOD_MTLS = 2;
  AUTH_METHOD_JWT = 3;
}

enum SessionState {
  SESSION_STATE_UNSPECIFIED = 0;
  SESSION_STATE_ACTIVE = 1;
  SESSION_STATE_EXPIRED = 2;
  SESSION_STATE_REVOKED = 3;
}

message OpenSessionRequest {
  string request_id = 1;
  string service_id = 2;
  string tenant_id = 3;
  AuthMethod method = 4;
  string api_key = 5;
  string jwt_assertion = 6;
  string client_cert_fingerprint = 7;
  string source_ip = 8;
}

message OpenSessionResponse {
  bool authenticated = 1;
  string session_id = 2;
  string access_token = 3;
  string refresh_token = 4;
  SessionState state = 5;
  int64 expires_at_ms = 6;
  repeated string scopes = 7;
  string reason = 8;
}

message RefreshSessionRequest {
  string request_id = 1;
  string session_id = 2;
  string refresh_token = 3;
}

message RefreshSessionResponse {
  bool refreshed = 1;
  string access_token = 2;
  string refresh_token = 3;
  int64 expires_at_ms = 4;
  string reason = 5;
}

message HandshakeRequest {
  string request_id = 1;
  string session_id = 2;
  string nonce = 3;
  string algorithm = 4;
  int64 timestamp_ms = 5;
}

message HandshakeResponse {
  bool ok = 1;
  string signature = 2;
  string server_public_key_id = 3;
  int64 server_time_ms = 4;
}

message RevokeSessionRequest {
  string request_id = 1;
  string session_id = 2;
  string reason = 3;
}

message RevokeSessionResponse {
  bool revoked = 1;
  SessionState state = 2;
}
