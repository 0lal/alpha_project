# -*- coding: utf-8 -*-
"""
اسم المكون: SSH Sovereign Genesis (مولد مفاتيح الوصول السيادية)
المسؤولية: توليد زوج مفاتيح SSH (عام/خاص) لملف ssh_sovereign.key.
الركيزة: الأمن والسيادة (Security Pillar)
التأثير الجنائي: هذا المفتاح يمنح حق الوصول الكامل (Root Access) للنظام عن بعد.
"""

import os
from pathlib import Path
from cryptography.hazmat.primitives import serialization as crypto_serialization
from cryptography.hazmat.primitives.asymmetric import rsa
from cryptography.hazmat.backends import default_backend
import logging

# إعداد السجلات للمتابعة الجنائية
logging.basicConfig(level=logging.INFO, format='%(asctime)s | SSH-GEN | %(levelname)s | %(message)s')
logger = logging.getLogger("AlphaAccess")

# المسارات المستهدفة الصحيحة (المفتاح الخاص والعام)
PRIVATE_KEY_PATH = Path(r"F:\win10\Linux\alpha_project\config\security\identity\ssh_sovereign.key")
PUBLIC_KEY_PATH = Path(r"F:\win10\Linux\alpha_project\config\security\identity\ssh_sovereign.pub")

def generate_sovereign_keys():
    """
    توليد مفاتيح RSA-4096 عالية الأمان.
    لماذا 4096؟ لأن 2048 لم يعد كافياً للأنظمة السيادية التي تخطط للعمل لعقد من الزمان.
    """
    logger.info("بدء بروتوكول توليد مفاتيح الوصول (Access Keys Protocol)...")

    # 1. توليد المفتاح الخاص (Private Key)
    # نستخدم Backend الافتراضي لضمان استخدام مولد الأرقام العشوائية الآمن في النظام (CSPRNG).
    key = rsa.generate_private_key(
        public_exponent=65537,
        key_size=4096,
        backend=default_backend()
    )
    logger.info("تم توليد إنتروبيا المفتاح بنجاح (4096-bit).")

    # 2. التأكد من وجود المجلد
    PRIVATE_KEY_PATH.parent.mkdir(parents=True, exist_ok=True)

    # 3. حفظ المفتاح الخاص (Private Key)
    # تنبيه جنائي: هذا الملف هو الأخطر في النظام. لا تشفره بكلمة مرور هنا لكي يستطيع
    # النظام الآلي (Automation) استخدامه، لكن يجب حماية المجلد بصلاحيات صارمة.
    try:
        with open(PRIVATE_KEY_PATH, "wb") as f:
            f.write(key.private_bytes(
                encoding=crypto_serialization.Encoding.PEM,
                format=crypto_serialization.PrivateFormat.TraditionalOpenSSL,
                encryption_algorithm=crypto_serialization.NoEncryption()
            ))
        
        # تعيين صلاحيات الملف لتكون للقراءة فقط للمالك (chmod 400 equivalent on Windows logic)
        # (هذه الخطوة تتم عادة عبر نظام التشغيل، لكننا نضمن وجود الملف أولاً)
        os.chmod(PRIVATE_KEY_PATH, 0o400)
        logger.info(f"تم حفظ المفتاح الخاص السري في: {PRIVATE_KEY_PATH}")

    except Exception as e:
        logger.error(f"فشل حرج في حفظ المفتاح الخاص: {e}")
        return

    # 4. حفظ المفتاح العام (Public Key)
    # هذا المفتاح يمكن مشاركته مع الخوادم الأخرى للسماح لهذا النظام بالدخول إليها.
    try:
        public_key = key.public_key()
        with open(PUBLIC_KEY_PATH, "wb") as f:
            f.write(public_key.public_bytes(
                encoding=crypto_serialization.Encoding.OpenSSH,
                format=crypto_serialization.PublicFormat.OpenSSH
            ))
        logger.info(f"تم حفظ المفتاح العام في: {PUBLIC_KEY_PATH}")
        
    except Exception as e:
        logger.error(f"فشل في حفظ المفتاح العام: {e}")

    logger.info("="*60)
    logger.info("اكتملت عملية التوليد.")
    logger.info("تحذير أمني: لا تقم أبداً بنسخ محتوى ملف .key أو إرساله عبر البريد.")
    logger.info("="*60)

if __name__ == "__main__":
    print("--- Alpha Sovereign Access Generator ---")
    generate_sovereign_keys()