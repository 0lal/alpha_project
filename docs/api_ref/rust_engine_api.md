بصفتي **كبير مهندسي البرمجيات (Principal Software Engineer)** والمسؤول عن توثيق الواجهات البرمجية (API Documentation)، سأقوم بصياغة `docs/api_ref/rust_engine_api.md`.

هذا الملف هو **"عقد التفاهم"**.
المحرك المكتوب بـ Rust هو "وحش" سريع ومعقد. واجهة المستخدم (Flutter) والعقل (Python) يحتاجان لكتيب تعليمات دقيق لترويض هذا الوحش.
هذه الوثيقة تشرح الدوال التي يصدرها Rust للعالم الخارجي عبر **FFI (Foreign Function Interface)**، وكيفية استدعائها بأمان دون التسبب في انهيار الذاكرة (Segmentation Fault).

إليك الوثيقة الكاملة بصيغة Markdown:

### الملف: `docs/api_ref/rust_engine_api.md`

```markdown
# ALPHA SOVEREIGN - RUST ENGINE API REFERENCE
================================================================================
**Component:** Engine (Muscle)
**Interface Type:** FFI (Foreign Function Interface) & ZMQ
**Consumer:** Flutter UI (Dart) & Python Brain
**Generated By:** flutter_rust_bridge (frb)
**Last Updated:** 2026-02-03
================================================================================

## 1. Overview (نظرة عامة)

يوفر محرك Rust نوعين من الواجهات:
1.  **Synchronous FFI:** دوال يتم استدعاؤها مباشرة من Dart (Flutter) للتحكم في النظام، قراءة الحالة، أو إرسال أوامر يدوية. تتميز بسرعة استجابة عالية (Nanoseconds).
2.  **Asynchronous ZMQ:** قنوات رسائل للتواصل مع `Brain` (تم توثيقها في `ipc_communication_flow.md`).

هذا المستند يركز على دوال **FFI** المتاحة لمطوري الواجهة.

---

## 2. Architecture: The Bridge (الجسر)



نستخدم مكتبة `flutter_rust_bridge` لتوليد كود الربط تلقائياً. هذا يضمن:
* **Type Safety:** تحويل أنواع البيانات (مثل `String` -> `&str` أو `Vec<u8>`) يتم بشكل آمن.
* **Async Support:** دوال Rust الثقيلة لا تجمد واجهة المستخدم (UI Thread) لأنها تعمل في `Isolate` منفصل.

---

## 3. Lifecycle Management (إدارة دورة الحياة)

دوال للتحكم في تشغيل وإيقاف المحرك.

### `start_engine()`
* **Description:** يقوم بتهيئة المحرك، فتح اتصالات قاعدة البيانات، وبدء خيوط ZMQ.
* **Signature:** `pub fn start_engine(config: Config) -> Result<(), AnyError>`
* **Dart Usage:**
    ```dart
    await api.startEngine(config: myConfig);
    ```

### `stop_engine()`
* **Description:** إغلاق آمن. يضمن تسييل المراكز (إذا تم تفعيله) وحفظ البيانات.
* **Signature:** `pub fn stop_engine() -> Result<(), AnyError>`

### `get_health_status()`
* **Description:** فحص نبض القلب لجميع المكونات الفرعية (DB, Network, Brain Link).
* **Returns:** `SystemHealth` struct.

---

## 4. Market Data Streams (تدفق بيانات السوق)

### `subscribe_ticker(symbol: String)`
* **Description:** الاشتراك في تحديثات الأسعار لزوج معين.
* **Input:** `symbol` (e.g., "BTCUSDT").
* **Stream:** يفتح `Stream<MarketTick>` في Dart يستقبل تحديثات فورية.

### `get_order_book(symbol: String, depth: u8)`
* **Description:** جلب لقطة (Snapshot) فورية لدفتر الأوامر.
* **Input:** `depth` (عدد المستويات، مثلاً 10).
* **Returns:** `OrderBookSnapshot` object.

---

## 5. Trading Operations (عمليات التداول)

> **⚠️ WARNING:** These functions bypass the AI Brain. They are "Manual Override" commands.

### `execute_manual_order(order: ManualOrderRequest)`
* **Description:** إرسال أمر تداول مباشر للبورصة.
* **Parameters (`ManualOrderRequest`):**
    * `symbol`: String
    * `side`: Enum (Buy/Sell)
    * `price`: Option<f64> (None for Market Order)
    * `quantity`: f64
    * `leverage`: u8
* **Returns:** `Result<String, ExecutionError>` (Returns Order ID if successful).
* **Risk Check:** Even manual orders pass through the `RiskManager`. If the order violates risk limits, it will be rejected.

### `cancel_all_orders(symbol: Option<String>)`
* **Description:** زر الطوارئ لإلغاء الأوامر.
* **Input:** إذا كان `None`، يلغي كل شيء في كل الأسواق.

---

## 6. Data Structures (هياكل البيانات)

الأنواع المشتركة بين Rust و Dart.

### `SystemHealth`
```rust
pub struct SystemHealth {
    pub engine_status: ServiceStatus, // Online, Degraded, Offline
    pub db_latency_ms: u64,
    pub active_connections: u32,
    pub memory_usage_mb: u64,
}

```

### `ServiceStatus` (Enum)

* `Online`
* `Degraded` (System works but slow/errors)
* `Offline`
* `Maintenance`

---

## 7. Error Handling (معالجة الأخطاء)

Rust يستخدم `Result<T, E>`. الجسر يحول الأخطاء تلقائياً إلى `FlutterError` في Dart.

| Rust Error Type | Dart Exception | Description |
| --- | --- | --- |
| `RiskViolation` | `RiskException` | Order exceeds limits. |
| `NetworkError` | `NetworkException` | Exchange disconnected. |
| `DbError` | `StorageException` | QuestDB write failed. |
| `Panic` | `PlatformException` | Critical engine failure (Crash). |

---

> **Engineering Note:** Do not modify the generated `bridge_generated.dart` file manually. Always run `flutter_rust_bridge_codegen` after modifying Rust structs.

```

### التحليل الهندسي للوثيقة:

1.  **العقد الصريح (`Explicit Contract`):**
    * الوثيقة تحدد بوضوح أسماء الدوال والأنواع.
    * هذا يسمح لفريق الواجهة (`UI Team`) بالعمل بالتوازي مع فريق المحرك (`Engine Team`) دون انتظار انتهاء الكود، لأن الواجهة (Interface) محددة مسبقاً.

2.  **تحذير التجاوز اليدوي (`Manual Override Warning`):**
    * تم وضع تحذير واضح عند دالة `execute_manual_order`.
    * هندسياً: النظام مصمم ليكون آلياً. التدخل البشري هو استثناء، ويجب توثيقه كحالة خاصة تتجاوز منطق الذكاء الاصطناعي ولكنها لا تتجاوز منطق المخاطر (`RiskManager`).

3.  **ترجمة الأخطاء (`Error Mapping`):**
    * الجدول في القسم 7 يحل واحدة من أكبر مشاكل التطوير: "ماذا يعني هذا الخطأ؟".
    * تحويل `Rust Panic` إلى `PlatformException` يسمح لتطبيق الموبايل بالتعامل مع انهيار المحرك بأناقة (إظهار رسالة خطأ بدلاً من إغلاق التطبيق فجأة).

---

### **حان وقت الحقيقة! (It is Time)** ⚡

لقد بنينا العالم كله، وثقناه، وأمنا حدوده.
لم يتبق سوى **إطلاق الروح**.

نحن الآن عند بوابة **`shield/core`**.
الملف الأول والأساسي: **`shield/core/brain_router.py`**.

هذا الملف سيربط كل ما تحدثنا عنه (ZMQ, Logs, Database, Config) في كيان واحد.
هل أنت مستعد لبدء البرمجة الحقيقية؟

```